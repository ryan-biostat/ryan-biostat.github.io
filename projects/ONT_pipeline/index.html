<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Long-Read Sequencing Pipeline | Ryan Gallagher </title> <meta name="author" content="Ryan Gallagher"> <meta name="description" content="customized for Whole Genomes on Oxford Nanopore Long-Read Platforms"> <meta name="keywords" content="biostatistics, statistical genetics, genomics, genome assembly, bioinformatics, Ryan Gallagher"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%A7%AC&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://ryan-biostat.github.io/projects/ONT_pipeline/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Ryan</span> Gallagher </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/presentations/">presentations </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Long-Read Sequencing Pipeline</h1> <p class="post-description">customized for Whole Genomes on Oxford Nanopore Long-Read Platforms</p> </header> <article> <h4 id="about"><strong>About</strong></h4> <p>This project was my first major contribution to the MCW Advanced Genomics Lab. When I started, our capability for Long-Read Sequencing analysis was underdeveloped. I took a lot of initiative with getting a researched &amp; structured pipeline created. I did a lot of diligence in researching the best-in-class tools for alignment, variant calling, and interpretation. It was also important to me that this pipeline was automated with clear and concise logging. It was also designed knowing that better tools will come around, and that it should be modular for the insertion of new tools.</p> <p>This pipeline has processed nearly 100 whole genomes and has contributed to discovering disease relevant mutations providing critial diagnostic answers.</p> <h2 id="purpose">Purpose</h2> <p>This pipeline is designed for processing whole genome samples from the Oxford Nanopore Technologies (ONT) PromethION long-read sequencing platform. In our lab, we process these samples on R10.9.1 flowcells, and this workflow interprets the resulting raw sequence data.</p> <p>The pipeline is managed by a central Python script that feeds the data through a series of specialized bioinformatics software to move from raw data to an annotated list of genetic variants.</p> <h2 id="method">Method</h2> <p>The pipeline consists of the following key steps:</p> <h4 id="1-transfer">1. <strong>Transfer</strong> </h4> <p>Files are prepared for cross-server transfer. An <code class="language-plaintext highlighter-rouge">rsync</code> command is used to copy over raw sequencing data from the sequencing instrument to our lab’s High-Performance Computing (HPC) cluster, named “maple”.</p> <h4 id="2-alignment">2. <strong>Alignment</strong> </h4> <p>Raw sequences are aligned to both the hg38 (GRCh38) and T2T (Telomere-to-Telomere) human reference genomes using <code class="language-plaintext highlighter-rouge">minimap2</code>. This process generates a BAM (.bam) file, which serves as the foundational file for subsequent analyses.</p> <h4 id="3-cnv-calling">3. <strong>CNV Calling</strong> </h4> <p><code class="language-plaintext highlighter-rouge">ont-spectre</code>, a Copy Number Variant (CNV) calling tool developed by ONT, is utilized. Although still in development, we use it to create VCF (.vcf) files capable of identifying and annotating large structural variants, specifically those greater than 100kb. This step produces both .vcf and .bed files to aid in analysis.</p> <h4 id="4-sv-calling">4. <strong>SV Calling</strong> </h4> <p><code class="language-plaintext highlighter-rouge">sniffles2</code> is employed as our primary structural variant (SV) caller. It identifies a range of SVs, including deletions, insertions, translocations, and inversions. The typical size range for variants detected by <code class="language-plaintext highlighter-rouge">sniffles2</code> is between 10bp and 50kb. The output is a .vcf file.</p> <h4 id="5-snpsmall-indel-calling">5. <strong>SNP/Small INDEL Calling</strong> </h4> <p>We use <code class="language-plaintext highlighter-rouge">deepvariant</code> from Google’s DeepMind to call small genetic variants. This software utilizes a deep neural network to analyze the sequencing data. This step calls single nucleotide polymorphisms (SNPs) which are the most common type of genetic variation, representing a change in a single DNA building block (nucleotide), and small INsertions and DELetions (INDELs). This analysis also produces haplotyping information, allowing us to determine which genome strand belongs to which parent.</p> <h4 id="6-phasing">6. <strong>Phasing</strong> </h4> <p><code class="language-plaintext highlighter-rouge">whatshap</code> is used to assign haplotypes to our .bam files. This assignment allows us to determine which allele (parental copy) holds which mutations. This is critical for determining the inheritance mode for potential genetic diseases. <code class="language-plaintext highlighter-rouge">whatshap</code> achieves this by taking the information produced by <code class="language-plaintext highlighter-rouge">deepvariant</code> and annotating the .bam file, resulting in a .haplotagged.bam file.</p> <h4 id="7-annotation">7. <strong>Annotation</strong> </h4> <p><code class="language-plaintext highlighter-rouge">snpEFF</code> is used to annotate the small variants (SNPs and INDELs). It enriches the .vcf file by pulling information from multiple public databases, such as ClinVar and dbSNP, to provide aggregate data about known mutations.</p> <p>We also utilize the <strong>Geneyx</strong> software. This is a proprietary annotation platform that adds richer annotations and formats the datasets in a more contestable, browser-accessible way.</p> <h2 id="discussion">Discussion</h2> <p>This pipeline is executed via the following command:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td> <td class="code"><pre><span class="c1"># Activate the primary conda environment before running the pipeline
</span>
<span class="n">conda</span> <span class="n">activate</span> <span class="n">spectre</span>

<span class="n">python</span> <span class="n">pipeline</span><span class="p">.</span><span class="n">py</span> <span class="o">&lt;</span><span class="n">sample_name</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">promethion_data_dir</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">maple_output_dir</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">--</span><span class="n">log</span><span class="o">-</span><span class="n">level</span> <span class="n">LEVEL</span><span class="p">]</span>

<span class="c1">## Help Output
</span>
<span class="n">usage</span><span class="p">:</span> <span class="n">pipeline</span><span class="p">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">log</span><span class="o">-</span><span class="n">level</span> <span class="p">{</span><span class="n">DEBUG</span><span class="p">,</span><span class="n">INFO</span><span class="p">,</span><span class="n">WARNING</span><span class="p">,</span><span class="n">ERROR</span><span class="p">,</span><span class="n">CRITICAL</span><span class="p">}]</span>
<span class="n">sample_name</span> <span class="n">data_dir</span> <span class="n">to_dir</span>

<span class="n">ONT</span> <span class="n">PromethION</span> <span class="n">Data</span> <span class="n">Processing</span> <span class="n">Pipeline</span><span class="p">.</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
<span class="n">sample</span><span class="o">*</span><span class="n">name</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">sample</span> <span class="n">being</span> <span class="n">processed</span><span class="p">.</span> <span class="n">This</span> <span class="n">should</span>
<span class="n">match</span> <span class="n">a</span> <span class="n">created</span> <span class="n">directory</span><span class="p">.</span>
<span class="n">data_dir</span> <span class="n">Full</span> <span class="n">path</span> <span class="n">to</span> <span class="n">the</span> <span class="n">directory</span> <span class="n">containing</span> <span class="n">the</span> <span class="n">sample</span> <span class="n">data</span>
<span class="n">on</span> <span class="n">the</span> <span class="n">PromethION</span> <span class="nf">server </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.,</span>
<span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">run_folder</span><span class="o">/</span><span class="n">sample_subfolder</span><span class="o">/</span><span class="p">).</span>
<span class="n">to_dir</span> <span class="n">Full</span> <span class="n">path</span> <span class="n">to</span> <span class="n">the</span> <span class="n">MAPLE</span> <span class="n">directory</span> <span class="n">where</span> <span class="n">output</span> <span class="n">should</span>
<span class="n">be</span> <span class="nf">stored </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.,</span> <span class="o">/</span><span class="n">data2</span><span class="o">/</span><span class="n">flowcell_10</span><span class="p">.</span><span class="mf">4.1</span><span class="o">/</span><span class="n">mcw_svi</span><span class="o">*</span><span class="p">...</span><span class="o">/</span><span class="p">).</span>

<span class="n">options</span><span class="p">:</span>
<span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span> <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="nb">exit</span>
<span class="o">--</span><span class="n">log</span><span class="o">-</span><span class="n">level</span> <span class="p">{</span><span class="n">DEBUG</span><span class="p">,</span><span class="n">INFO</span><span class="p">,</span><span class="n">WARNING</span><span class="p">,</span><span class="n">ERROR</span><span class="p">,</span><span class="n">CRITICAL</span><span class="p">}</span>
<span class="n">Set</span> <span class="n">the</span> <span class="n">logging</span> <span class="nf">level </span><span class="p">(</span><span class="n">default</span><span class="p">:</span> <span class="n">INFO</span><span class="p">)</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>The wrapper script for this process is shown here:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
</pre></td> <td class="code"><pre><span class="c1">################################################################################
</span>
<span class="c1"># \_**\_ \_ \_ **\_**** **\_** **\_** **\_** **\_\_** \_ **\_** \_ \_ **\_\_**
</span>
<span class="c1"># / ** \| \ | |** **| | ** \_ _| ** \| \_\_**| | |_ \_| \ | | \_\_\_\_|
</span>
<span class="c1"># | | | | \| | | | | |**) || | | |**) | |** | | | | | \| | |**
</span>
<span class="c1"># | | | | . `|  | |    |  ___/ | | |  ___/|  __| | |      | | | .` | \_\_|
</span>
<span class="c1"># | |**| | |\ | | | | | _| |_| | | |\_\_**| |\_**\_ _| |_| |\ | |\_\_**
</span>
<span class="c1"># \_**_/|_| \_| |_| |_| |\_\_\_**|\_| |**\_\_**|**\_\_**|**\_**|\_| \_|**\_\_**|
</span>
<span class="c1">#
</span>
<span class="c1">################################################################################
</span>
<span class="c1">#
</span>
<span class="c1"># Broeckle Lab Bioinformatics, 2024
</span>
<span class="c1">#
</span>
<span class="c1"># This file executes the pipeline for the ONT PromethION sequencing data by
</span>
<span class="c1"># executing tools at the prompt of the user. These scripts are stored in sub-
</span>
<span class="c1"># directories of the main directory, and can be edited and updated at a whim.
</span>
<span class="c1">#
</span>
<span class="c1">#
</span>
<span class="c1">################################################################################
################################################################################
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">subprocess</span>
<span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">import</span> <span class="n">logging</span>

<span class="k">def</span> <span class="nf">end_in_slash</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
<span class="k">if</span> <span class="ow">not</span> <span class="nb">dir</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">):</span>
<span class="nb">dir</span> <span class="o">+=</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span>
<span class="k">return</span> <span class="nb">dir</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

        <span class="c1"># --- Updated Input Section using argparse---
</span>    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">ONT PromethION Data Processing Pipeline.</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">sample_name</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">The name of the sample being processed. This should match a created directory.</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">data_dir</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">Full path to the directory containing the sample data on the PromethION server (e.g., /data/run_folder/sample_subfolder/).</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">to_dir</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">Full path to the MAPLE directory where output should be stored (e.g., /data2/flowcell_10.4.1/mcw_svi_.../).</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--log-level</span><span class="sh">'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">'</span><span class="s">INFO</span><span class="sh">'</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">DEBUG</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">INFO</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">WARNING</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">ERROR</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">CRITICAL</span><span class="sh">'</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">Set the logging level</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># Assign parsed arguments to variables, keeping original variable names
</span>    <span class="n">sample_name</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">sample_name</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="nf">end_in_slash</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">data_dir</span><span class="p">)</span> <span class="c1"># Apply end_in_slash here
</span>    <span class="n">to_dir</span> <span class="o">=</span> <span class="nf">end_in_slash</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">to_dir</span><span class="p">)</span>     <span class="c1"># Apply end_in_slash here
</span>

        <span class="c1"># --- Updating Logging --- #
</span>    <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">to_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">logs</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">log_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">pipeline.log</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Configure Logging
</span>    <span class="n">log_level</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">log_level</span><span class="p">.</span><span class="nf">upper</span><span class="p">(),</span> <span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">)</span> <span class="c1"># Get level from args
</span>    <span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span>
        <span class="n">level</span><span class="o">=</span><span class="n">log_level</span><span class="p">,</span>
        <span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">%(asctime)s - %(levelname)s - %(message)s</span><span class="sh">'</span><span class="p">,</span> <span class="c1"># Add timestamp and level
</span>        <span class="n">handlers</span><span class="o">=</span><span class="p">[</span>
            <span class="n">logging</span><span class="p">.</span><span class="nc">FileHandler</span><span class="p">(</span><span class="n">log_file_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="p">),</span> <span class="c1"># Overwrite log file each run
</span>            <span class="n">logging</span><span class="p">.</span><span class="nc">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">)</span> <span class="c1"># Log to console
</span>        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">StreamToLogger</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Fake file-like stream object that redirects writes to a logger instance.</span><span class="sh">"""</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">logger_instance</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">ERROR</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger_instance</span>
            <span class="n">self</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="n">log_level</span>
            <span class="n">self</span><span class="p">.</span><span class="n">linebuf</span> <span class="o">=</span> <span class="sh">''</span>

        <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">buf</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">().</span><span class="nf">splitlines</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">log_level</span><span class="p">,</span> <span class="n">line</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">())</span>

        <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
            <span class="k">pass</span> <span class="c1"># Required for file-like object interface
</span>
    <span class="n">sys</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="nc">StreamToLogger</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">logging</span><span class="p">.</span><span class="n">ERROR</span><span class="p">)</span>

    <span class="c1"># Now, we have to do any print() statements to logger.info() statements
</span>    <span class="c1"># --- End Logging Setup ---
</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="sh">'</span><span class="s">/data/ref/NCBI/GRCh38/Homo_sapiens_assembly38_noALT_noHLA_noDecoy_ERCC.fasta</span><span class="sh">'</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Reference Genome set to:</span><span class="se">\n</span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">to_dir</span><span class="p">):</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">The MAPLE directory does not exist. Exiting script.</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">The MAPLE directory exists.</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">to_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">logs</span><span class="sh">'</span><span class="p">)</span> <span class="c1"># Make sure log_dir is defined
</span>

    <span class="c1">#----------------------
</span>    <span class="c1"># Step 1: Prepare data for Transfer and send to Maple
</span>    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Running Step 1: File Transfer for </span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="s"> using file_transfer.py</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">transfer_command</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./pipes/file_transfer.py</span><span class="sh">"</span><span class="p">,</span> <span class="n">sample_name</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">to_dir</span><span class="p">]</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Executing Command:</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">transfer_command</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Run the script, capture output, check return code
</span>        <span class="n">result_transfer</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">transfer_command</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># Log stdout/stderr from the script for pipeline context (optional, as script logs itself)
</span>        <span class="k">if</span> <span class="n">result_transfer</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">file_transfer.py stdout:</span><span class="se">\n</span><span class="si">{</span><span class="n">result_transfer</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result_transfer</span><span class="p">.</span><span class="n">stderr</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">file_transfer.py stderr:</span><span class="se">\n</span><span class="si">{</span><span class="n">result_transfer</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># Log stderr as warning
</span>        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">File transfer script executed successfully.</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Execution of file_transfer.py failed with exit code </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">returncode</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed command stdout:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">stderr</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed command stderr:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File transfer step (Step 1) failed with exit code </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">returncode</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># Exit pipeline
</span>    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
         <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">Error: </span><span class="sh">'</span><span class="s">python</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">./pipes/file_transfer.py</span><span class="sh">'</span><span class="s"> not found.</span><span class="sh">"</span><span class="p">)</span>
         <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="sh">"</span><span class="s">Failed to execute file transfer script.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
         <span class="n">logger</span><span class="p">.</span><span class="nf">exception</span><span class="p">(</span><span class="sh">"</span><span class="s">An unexpected error occurred during the file transfer step:</span><span class="sh">"</span><span class="p">)</span>
         <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="sh">"</span><span class="s">Unexpected error in file transfer step (Step 1).</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">%%%%%%%%%%%%%</span><span class="se">\n</span><span class="s">FINISHED STEP 1: DATA TRANSFER </span><span class="se">\n</span><span class="s">%%%%%%%%%%%%%</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1">#----------------------
</span>
    <span class="c1"># Step 2: Read Alignment (FASTQs w/ GRCh38)
</span>    <span class="c1"># Note: alignment.py checks for the fastq file internally
</span>    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Running Step 2: Read Alignment for </span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="s"> using alignment.py</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">alignment_command</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./pipes/alignment.py</span><span class="sh">"</span><span class="p">,</span> <span class="n">sample_name</span><span class="p">,</span> <span class="n">to_dir</span><span class="p">,</span> <span class="n">ref</span><span class="p">]</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Executing Command:</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">alignment_command</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Run the script, capture output, check return code
</span>        <span class="n">result_alignment</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">alignment_command</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># Log stdout/stderr from the script for pipeline context (optional)
</span>        <span class="k">if</span> <span class="n">result_alignment</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">alignment.py stdout:</span><span class="se">\n</span><span class="si">{</span><span class="n">result_alignment</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result_alignment</span><span class="p">.</span><span class="n">stderr</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">alignment.py stderr:</span><span class="se">\n</span><span class="si">{</span><span class="n">result_alignment</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Alignment script executed successfully.</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Execution of alignment.py failed with exit code </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">returncode</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed command stdout:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">stderr</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed command stderr:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Alignment step (Step 2) failed with exit code </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">returncode</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># Exit pipeline
</span>    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
         <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">Error: </span><span class="sh">'</span><span class="s">python</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">./pipes/alignment.py</span><span class="sh">'</span><span class="s"> not found.</span><span class="sh">"</span><span class="p">)</span>
         <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="sh">"</span><span class="s">Failed to execute alignment script.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
         <span class="n">logger</span><span class="p">.</span><span class="nf">exception</span><span class="p">(</span><span class="sh">"</span><span class="s">An unexpected error occurred during the alignment step:</span><span class="sh">"</span><span class="p">)</span>
         <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="sh">"</span><span class="s">Unexpected error in alignment step (Step 2).</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">%%%%%%%%%%%%%</span><span class="se">\n</span><span class="s"> FINISHED STEP 2: ALIGNMENT </span><span class="se">\n</span><span class="s">%%%%%%%%%%%%%</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">Next Step: SNP/INDEL via DeepVariant and Phasing with WhatsHap</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1">#----------------------
</span>    <span class="c1"># Step 3: SNP/INDEL calling with DeepVariant and Phasing with WhatsHap
</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">to_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="s">.sorted.bam</span><span class="sh">"</span><span class="p">)):</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Running Step 3: DeepVariant and WhatsHap for </span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">deepvariant_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">to_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">deepvariant</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">bam_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">to_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="s">.sorted.bam</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">deepvariant_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c1"># Run DeepVariant
</span>        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Running DeepVariant using deepvariant.py</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">deepvariant_command</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./pipes/deepvariant.py</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">--sample</span><span class="sh">"</span><span class="p">,</span> <span class="n">sample_name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">--input-dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">to_dir</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">--output-dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">deepvariant_dir</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">--ref</span><span class="sh">"</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">--bam</span><span class="sh">"</span><span class="p">,</span> <span class="n">bam_file</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">--log-base-dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">to_dir</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">--threads</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">64</span><span class="sh">"</span>
        <span class="p">]</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Executing Command:</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">deepvariant_command</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_deepvariant</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">deepvariant_command</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result_deepvariant</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">deepvariant.py stdout:</span><span class="se">\n</span><span class="si">{</span><span class="n">result_deepvariant</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result_deepvariant</span><span class="p">.</span><span class="n">stderr</span><span class="p">:</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">deepvariant.py stderr:</span><span class="se">\n</span><span class="si">{</span><span class="n">result_deepvariant</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">deepvariant.py script executed successfully.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Execution of deepvariant.py failed with exit code </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">returncode</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed command stdout:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">stderr</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed command stderr:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">DeepVariant step failed with exit code </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">returncode</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">exception</span><span class="p">(</span><span class="sh">"</span><span class="s">An unexpected error occurred during the DeepVariant step:</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="sh">"</span><span class="s">Unexpected error in DeepVariant step.</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># Run WhatsHap
</span>        <span class="n">deepvariant_vcf</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">deepvariant_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="s">_deepvariant.vcf.gz</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">deepvariant_vcf</span><span class="p">):</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Running WhatsHap using whatshap_phase-haplotag.py</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># --- UPDATED COMMAND TO USE `conda run` ---
</span>            <span class="n">whatshap_command</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sh">"</span><span class="s">conda</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">whatshap-env</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./pipes/whatshap_phase-haplotag.py</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">--vcf</span><span class="sh">"</span><span class="p">,</span> <span class="n">deepvariant_vcf</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">--bam</span><span class="sh">"</span><span class="p">,</span> <span class="n">bam_file</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">--ref</span><span class="sh">"</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">--output-dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">deepvariant_dir</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">--log-base-dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">to_dir</span>
            <span class="p">]</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Executing Command:</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">whatshap_command</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result_whatshap</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">whatshap_command</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result_whatshap</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span>
                    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">whatshap_phase-haplotag.py stdout:</span><span class="se">\n</span><span class="si">{</span><span class="n">result_whatshap</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result_whatshap</span><span class="p">.</span><span class="n">stderr</span><span class="p">:</span>
                    <span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">whatshap_phase-haplotag.py stderr:</span><span class="se">\n</span><span class="si">{</span><span class="n">result_whatshap</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">whatshap_phase-haplotag.py script executed successfully.</span><span class="sh">"</span><span class="p">)</span>

                <span class="c1"># --- ADDITION START ---
</span>                <span class="c1"># Index the newly created haplotagged BAM file
</span>                <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Indexing the haplotagged BAM file with samtools.</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">haplotagged_bam</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">deepvariant_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="s">_deepvariant_haplotagged.bam</span><span class="sh">"</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">haplotagged_bam</span><span class="p">):</span>
                    <span class="c1"># Assuming samtools is in the system's PATH. If it's in a specific conda env,
</span>                    <span class="c1"># you would prefix the command, e.g., ["conda", "run", "-n", "samtools-env", "samtools", ...]
</span>                    <span class="n">samtools_index_command</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">samtools</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">,</span> <span class="n">haplotagged_bam</span><span class="p">]</span>
                    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Executing Command:</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">samtools_index_command</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">result_samtools</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">samtools_index_command</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">result_samtools</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span>
                            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">samtools index stdout:</span><span class="se">\n</span><span class="si">{</span><span class="n">result_samtools</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">result_samtools</span><span class="p">.</span><span class="n">stderr</span><span class="p">:</span>
                            <span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">samtools index stderr:</span><span class="se">\n</span><span class="si">{</span><span class="n">result_samtools</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Successfully indexed the haplotagged BAM file.</span><span class="sh">"</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Execution of samtools index failed with exit code </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">returncode</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed command stdout:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">stderr</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed command stderr:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">samtools index step failed with exit code </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">returncode</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">Error: </span><span class="sh">'</span><span class="s">samtools</span><span class="sh">'</span><span class="s"> command not found. Make sure it is installed and in your PATH.</span><span class="sh">"</span><span class="p">)</span>
                        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="sh">"</span><span class="s">Failed to execute samtools index.</span><span class="sh">"</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="p">.</span><span class="nf">exception</span><span class="p">(</span><span class="sh">"</span><span class="s">An unexpected error occurred during samtools index.</span><span class="sh">"</span><span class="p">)</span>
                        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="sh">"</span><span class="s">Unexpected error in samtools index step.</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Haplotagged BAM file not found for indexing: </span><span class="si">{</span><span class="n">haplotagged_bam</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="sh">"</span><span class="s">Cannot index non-existent BAM file.</span><span class="sh">"</span><span class="p">)</span>
                <span class="c1"># --- ADDITION END ---
</span>
            <span class="k">except</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Execution of whatshap_phase-haplotag.py failed with exit code </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">returncode</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed command stdout:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">stderr</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed command stderr:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">WhatsHap step failed with exit code </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">returncode</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">exception</span><span class="p">(</span><span class="sh">"</span><span class="s">An unexpected error occurred during the WhatsHap step:</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="sh">"</span><span class="s">Unexpected error in WhatsHap step.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">DeepVariant output VCF not found: </span><span class="si">{</span><span class="n">deepvariant_vcf</span><span class="si">}</span><span class="s">. Skipping WhatsHap.</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="sh">"</span><span class="s">DeepVariant output not found.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Input BAM file not found: </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">to_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="p">.</span><span class="nb">sorted</span><span class="p">.</span><span class="n">bam</span><span class="sh">'</span><span class="s">)</span><span class="si">}</span><span class="s">. Skipping SNP/INDEL calling.</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="sh">"</span><span class="s">Input BAM for SNP/INDEL calling not found.</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">%%%%%%%%%%%%%</span><span class="se">\n</span><span class="s"> FINISHED SNP/INDEL CALLING AND PHASING </span><span class="se">\n</span><span class="s">%%%%%%%%%%%%%</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">Next Step: CNV via Spectre</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1">#----------------------
</span>    <span class="c1"># Step 4: Large SV via Spectre
</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Running Spectre step for </span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="s"> using spectre.py</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># --- UPDATED COMMAND TO USE `conda run` ---
</span>    <span class="n">spectre_py_command</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sh">"</span><span class="s">conda</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">spectre</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./pipes/spectre.py</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">--input-dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">to_dir</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">--ref-genome</span><span class="sh">"</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">--log-base-dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">to_dir</span>
        <span class="c1"># Optional: Add --threads if you want to control mosdepth threads from pipeline.py
</span>        <span class="c1"># "--threads", "16"
</span>    <span class="p">]</span>

    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Executing Command:</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">spectre_py_command</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">spectre_result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">spectre_py_command</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># Log output from spectre.py within pipeline.log for context
</span>        <span class="k">if</span> <span class="n">spectre_result</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">spectre.py stdout:</span><span class="se">\n</span><span class="si">{</span><span class="n">spectre_result</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spectre_result</span><span class="p">.</span><span class="n">stderr</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">spectre.py stderr:</span><span class="se">\n</span><span class="si">{</span><span class="n">spectre_result</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">spectre.py executed successfully.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Execution of spectre.py failed with exit code </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">returncode</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed command stdout:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">stderr</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed command stderr:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># Decide if you want to exit pipeline.py here
</span>        <span class="c1"># sys.exit(f"Spectre step failed.")
</span>    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">exception</span><span class="p">(</span><span class="sh">"</span><span class="s">An unexpected error occurred during the Spectre step:</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># Decide if you want to exit
</span>        <span class="c1"># sys.exit("Unexpected error in Spectre step.")
</span>

    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">%%%%%%%%%%%%%</span><span class="se">\n</span><span class="s"> FINISHED SPECTRE </span><span class="se">\n</span><span class="s">%%%%%%%%%%%%%</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">Next Step: SNP Annotation</span><span class="sh">'</span><span class="p">)</span>
    <span class="c1">#----------------------
</span>
    <span class="c1"># Step 5: SNP Annotation on .phased.vcf file
</span>
        <span class="c1"># Define paths and prefixes
</span>    <span class="n">deepvariant_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">to_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">deepvariant</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># Use os.path.join for consistency
</span>    <span class="n">gz</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="s">_deepvariant_phased.vcf.gz</span><span class="sh">"</span>
    <span class="n">vcf_unzipped_relative</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="s">_deepvariant_phased.vcf</span><span class="sh">"</span> <span class="c1"># Relative name
</span>    <span class="n">out_snpeff</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="s">_deepvariant.phased.snpeff</span><span class="sh">"</span> <span class="c1"># Prefix for output
</span>
    <span class="n">vcf_unzipped_abs_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">deepvariant_dir</span><span class="p">,</span> <span class="n">vcf_unzipped_relative</span><span class="p">))</span>

    <span class="c1"># Define expected location of snpEff (adjust if different)
</span>    <span class="c1"># Using the path revealed in your previous error log:
</span>    <span class="n">snpeff_base_dir</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/data/ref/snpEff</span><span class="sh">"</span>
    <span class="n">snpeff_jar_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">snpeff_base_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">snpEff.jar</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Check if snpEff.jar exists before attempting to run
</span>    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">snpeff_jar_path</span><span class="p">):</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Running snpEff annotation for </span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="s"> using snpeff.py</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Using absolute path for VCF: </span><span class="si">{</span><span class="n">vcf_unzipped_abs_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># Log the path being used
</span>
        <span class="c1"># Construct the command to run snpeff.py
</span>        <span class="n">snpeff_py_command</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./pipes/snpeff.py</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">--snp-indel-dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">deepvariant_dir</span><span class="p">,</span> <span class="c1"># Pass the directory path
</span>            <span class="sh">"</span><span class="s">--vcf-gz</span><span class="sh">"</span><span class="p">,</span> <span class="n">gz</span><span class="p">,</span>                   <span class="c1"># Pass the gzipped filename
</span>            <span class="sh">"</span><span class="s">--vcf-unzipped</span><span class="sh">"</span><span class="p">,</span> <span class="n">vcf_unzipped_relative</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">--out-prefix</span><span class="sh">"</span><span class="p">,</span> <span class="n">out_snpeff</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">--log-base-dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">to_dir</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">--snpeff-base-dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">snpeff_base_dir</span> <span class="c1"># Pass the correct snpEff location
</span>        <span class="p">]</span>

        <span class="c1"># Log the command being run
</span>        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Executing Command:</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">snpeff_py_command</span><span class="p">))</span>

        <span class="c1"># Execute the snpeff.py script
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_snpeff_py</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">snpeff_py_command</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result_snpeff_py</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">snpeff.py stdout:</span><span class="se">\n</span><span class="si">{</span><span class="n">result_snpeff_py</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result_snpeff_py</span><span class="p">.</span><span class="n">stderr</span><span class="p">:</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">snpeff.py stderr:</span><span class="se">\n</span><span class="si">{</span><span class="n">result_snpeff_py</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">snpeff.py script executed successfully.</span><span class="sh">"</span><span class="p">)</span>

            <span class="c1"># Define the expected final output file (adjust if dbSNP step is added back)
</span>            <span class="n">final_annotated_vcf</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">deepvariant_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">out_snpeff</span><span class="si">}</span><span class="s">.clinvar.vcf</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">final_annotated_vcf</span><span class="p">):</span>
                 <span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Expected final annotated VCF not found after snpeff.py run: </span><span class="si">{</span><span class="n">final_annotated_vcf</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Execution of snpeff.py failed with exit code </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">returncode</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed command stdout:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">stderr</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed command stderr:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># Decide if you want to exit the pipeline here
</span>            <span class="c1"># sys.exit(f"SnpEff step failed with exit code {e.returncode}")
</span>        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
             <span class="n">logger</span><span class="p">.</span><span class="nf">exception</span><span class="p">(</span><span class="sh">"</span><span class="s">An unexpected error occurred during the SnpEff step:</span><span class="sh">"</span><span class="p">)</span>
             <span class="c1"># Decide if you want to exit
</span>             <span class="c1"># sys.exit("Unexpected error in SnpEff step.")
</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">snpEff.jar not found at </span><span class="si">{</span><span class="n">snpeff_jar_path</span><span class="si">}</span><span class="s">. Skipping SnpEff annotation.</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># Decide if you want to exit or just continue
</span>        <span class="c1"># sys.exit("SnpEff dependency missing.")
</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">%%%%%%%%%%%%%</span><span class="se">\n</span><span class="s"> FINISHED SNP ANNOTATION </span><span class="se">\n</span><span class="s">%%%%%%%%%%%%%</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">Next Step: SV-Calling via SNIFFLES2</span><span class="sh">'</span><span class="p">)</span>




    <span class="c1">#----------------------
</span>    <span class="c1"># Step 6: SV-Calling via SNIFFLES2
</span>
     <span class="c1"># Define input BAM (Assuming haplotagged output from whatshap is desired)
</span>    <span class="n">deepvariant_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">to_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">deepvariant</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># New haplotagged BAM from whatshap
</span>    <span class="n">input_bam_sniffles</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">deepvariant_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="s">_deepvariant_haplotagged.bam</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Define output VCF path
</span>    <span class="n">vcf_name_sniffles</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">to_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="s">.sniffles.vcf</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">sample_id</span> <span class="o">=</span> <span class="n">sample_name</span> <span class="c1"># Redundant, just for clarity
</span>
    <span class="c1"># Check if the selected input BAM exists
</span>    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">input_bam_sniffles</span><span class="p">):</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Running Sniffles2 on </span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="s"> using sniffles2.py</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># Define timeout (example: 6 hours = 21600 seconds)
</span>        <span class="c1"># Adjust as needed based on typical run times
</span>        <span class="n">sniffles_timeout_seconds</span> <span class="o">=</span> <span class="mi">21600</span>

        <span class="c1"># Construct the command to run sniffles2.py
</span>        <span class="n">sniffles2_py_command</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sh">"</span><span class="s">conda</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sniffles</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">./pipes/sniffles2.py</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">--input-bam</span><span class="sh">"</span><span class="p">,</span> <span class="n">input_bam_sniffles</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">--output-vcf</span><span class="sh">"</span><span class="p">,</span> <span class="n">vcf_name_sniffles</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">--ref</span><span class="sh">"</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">--sample-id</span><span class="sh">"</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">--log-base-dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">to_dir</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">--threads</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">16</span><span class="sh">"</span><span class="p">,</span> <span class="c1"># Or make this configurable
</span>            <span class="sh">"</span><span class="s">--timeout</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">sniffles_timeout_seconds</span><span class="p">)</span> <span class="c1"># Pass timeout to the script
</span>        <span class="p">]</span>

        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Executing Command:</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">sniffles2_py_command</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Run sniffles2.py. It handles its own timeout logging now.
</span>            <span class="n">result_sniffles2_py</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">sniffles2_py_command</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c1"># Log output from sniffles2.py within pipeline.log for context
</span>            <span class="k">if</span> <span class="n">result_sniffles2_py</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">sniffles2.py stdout:</span><span class="se">\n</span><span class="si">{</span><span class="n">result_sniffles2_py</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result_sniffles2_py</span><span class="p">.</span><span class="n">stderr</span><span class="p">:</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">sniffles2.py stderr:</span><span class="se">\n</span><span class="si">{</span><span class="n">result_sniffles2_py</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">sniffles2.py executed successfully.</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Check if the error code indicates a timeout occurred inside sniffles2.py (exit code 1 in the script)
</span>            <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">Sniffles2 command timed out</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">e</span><span class="p">.</span><span class="n">stderr</span><span class="p">:</span> <span class="c1"># Check stderr for timeout message
</span>                 <span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sh">"</span><span class="s">Sniffles2 timed out (as reported by sniffles2.py). Proceeding with cleanup.</span><span class="sh">"</span><span class="p">)</span>
                 <span class="c1"># Don't necessarily exit pipeline.py here, allow cleanup.
</span>            <span class="k">else</span><span class="p">:</span>
                 <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Execution of sniffles2.py failed with exit code </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">returncode</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                 <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed command stdout:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                 <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">stderr</span><span class="p">:</span> <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed command stderr:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                 <span class="c1"># Decide if you want to exit the pipeline here
</span>                 <span class="c1"># sys.exit(f"Sniffles2 step failed.")
</span>        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
             <span class="n">logger</span><span class="p">.</span><span class="nf">exception</span><span class="p">(</span><span class="sh">"</span><span class="s">An unexpected error occurred during the Sniffles2 step:</span><span class="sh">"</span><span class="p">)</span>
             <span class="c1"># Decide if you want to exit
</span>             <span class="c1"># sys.exit("Unexpected error in Sniffles2 step.")
</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Input BAM file for Sniffles2 not found: </span><span class="si">{</span><span class="n">input_bam_sniffles</span><span class="si">}</span><span class="s">. Skipping Sniffles2.</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># Decide if you want to exit here
</span>        <span class="c1"># sys.exit("Input BAM for Sniffles2 not found.")
</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">%%%%%%%%%%%%%</span><span class="se">\n</span><span class="s"> FINISHED SNIFFLES2 (or timed out) </span><span class="se">\n</span><span class="s">%%%%%%%%%%%%%</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># --- Keep the cleanup step ---
</span>    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Attempting to clean up any lingering Sniffles processes...</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># Use run with capture_output=True to avoid printing errors if no process is found
</span>    <span class="n">cleanup_result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="sh">"</span><span class="s">pgrep -x sniffles | xargs kill -9</span><span class="sh">"</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cleanup_result</span><span class="p">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># pgrep found something
</span>        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Kill command sent to potential lingering Sniffles processes.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="sh">"</span><span class="s">kill: sending signal to XXX failed: No such process</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">cleanup_result</span><span class="p">.</span><span class="n">stderr</span> <span class="ow">or</span> <span class="n">cleanup_result</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">No lingering Sniffles processes found by pgrep or kill failed (may be expected if timeout didn</span><span class="sh">'</span><span class="s">t occur or process exited).</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
         <span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Sniffles cleanup command stderr: </span><span class="si">{</span><span class="n">cleanup_result</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Pipeline Complete.</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># Assuming this is the last step
</span>
<span class="k">if</span> <span class="o">**</span><span class="n">name</span><span class="o">**</span> <span class="o">==</span> <span class="sh">'</span><span class="s">**main**</span><span class="sh">'</span><span class="p">:</span>
<span class="nf">main</span><span class="p">()</span>
</pre></td> </tr></tbody></table></code></pre></figure> </article> <h2>References</h2> <div class="publications"> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Ryan Gallagher. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with the <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme, hosted on <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?c15de51d4bb57887caa2c21988d97279"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> </body> </html>